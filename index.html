<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Pressure</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="#">Pressure</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="#chart">Chart</a></li>
                    </ul>
                    <div class="d-flex">
                        <button class="btn btn-outline-light btn-sm" onclick="window.location.reload()">Refresh</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <h1 class="display-5 fw-bold mb-3">Pressure</h1>
            <!-- Control panel under title -->
            <div class="d-flex align-items-center gap-2 mb-3">
                <button id="btnConnect" class="btn btn-success btn-sm">Connect</button>
                <button id="btnDisconnect" class="btn btn-outline-secondary btn-sm">Disconnect</button>
            </div>
            <!-- Panel + Chart row -->
            <div class="row mb-4">
                <!-- Left panel -->
                <div class="col-12 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Panel</h5>
                            <p class="text-muted mb-3">Controls and status</p>
                            <div class="vstack gap-2">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span class="fw-semibold">Connection</span>
                                    <span id="connStatus" class="badge text-bg-secondary">Idle</span>
                                </div>
                                <div class="d-flex align-items-center justify-content-between">
                                    <span class="fw-semibold">Rate</span>
                                    <span id="rateText" class="text-muted">5 points/sec</span>
                                </div>
                                <div class="mt-2">
                                    <label for="rateSlider" class="form-label mb-1">Adjust rate (pts/sec)</label>
                                    <input id="rateSlider" type="range" class="form-range" min="1" max="10" step="1" value="5">
                                </div>
                                <div class="d-flex align-items-center justify-content-between">
                                    <span class="fw-semibold">Window</span>
                                    <span class="text-muted">50 points</span>
                                </div>
                                <div>
                                    <button id="btnSeed" class="btn btn-outline-primary btn-sm">Seed 8 points</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Right chart -->
                <div class="col-12 col-lg-8">
                    <div id="chart" class="card h-100">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Live Pressure Chart</h6>
                            <div class="chart-container" style="position: relative; height: 320px;">
                                <canvas id="pressureChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Bootstrap JS (includes Popper) -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
        <script>
            (function () {
                const ctx = document.getElementById('pressureChart');
                if (!ctx) return;

                const data = {
                    labels: [],
                    datasets: [{
                        label: 'Pressure (psi)',
                        data: [],
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13,110,253,0.15)',
                        tension: 0.25,
                        pointRadius: 2,
                    }]
                };

                let chart = null;
                if (typeof Chart === 'function') {
                    chart = new Chart(ctx, {
                        type: 'line',
                        data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                x: { title: { display: true, text: 'Time' } },
                                y: { title: { display: true, text: 'psi' } }
                            },
                            plugins: {
                                legend: { display: true },
                                tooltip: { enabled: true }
                            }
                        }
                    });
                } else {
                    console.warn('Chart.js not loaded; demo will run without rendering.');
                }

                // Demo data stream
                let timer = null;
                let t0 = Date.now();
                const maxPoints = 50;
                let pointsPerSecond = 5; // default
                const randPsi = (prev) => {
                    const base = prev ?? 32;
                    const jitter = (Math.random() - 0.5) * 2.0; // Â±1.0
                    const next = Math.max(25, Math.min(45, base + jitter));
                    return Number(next.toFixed(2));
                };

                function addPoint() {
                    const elapsed = Math.floor((Date.now() - t0) / 1000);
                    const mm = String(Math.floor(elapsed / 60)).padStart(2, '0');
                    const ss = String(elapsed % 60).padStart(2, '0');
                    const label = `${mm}:${ss}`;
                    const arr = data.datasets[0].data;
                    const nextVal = randPsi(arr.length ? arr[arr.length - 1] : undefined);
                    data.labels.push(label);
                    arr.push(nextVal);
                    if (arr.length > maxPoints) {
                        data.labels.shift();
                        arr.shift();
                    }
                    if (chart) chart.update('none');
                }

                function startDemo() {
                    if (timer) return;
                    t0 = Date.now();
                    timer = setInterval(addPoint, Math.max(50, Math.floor(1000 / pointsPerSecond)));
                    // Disable/enable buttons on connect and style Disconnect green
                    const btnC = document.getElementById('btnConnect');
                    const btnD = document.getElementById('btnDisconnect');
                    const btnSeed = document.getElementById('btnSeed');
                    if (btnC) {
                        btnC.disabled = true;
                        btnC.classList.add('disabled');
                        // make Connect gray
                        btnC.classList.remove('btn-success');
                        btnC.classList.add('btn-secondary');
                    }
                    if (btnD) {
                        btnD.disabled = false;
                        btnD.classList.remove('disabled', 'btn-outline-secondary');
                        btnD.classList.add('btn-success');
                    }
                    if (btnSeed) {
                        btnSeed.disabled = true;
                        btnSeed.classList.add('disabled');
                        btnSeed.classList.remove('btn-outline-primary');
                        btnSeed.classList.add('btn-outline-secondary');
                    }
                }

                function stopDemo() {
                    if (!timer) return;
                    clearInterval(timer);
                    timer = null;
                    // Re-enable/disable buttons on disconnect and restore Disconnect style
                    const btnC = document.getElementById('btnConnect');
                    const btnD = document.getElementById('btnDisconnect');
                    const btnSeed = document.getElementById('btnSeed');
                    if (btnC) {
                        btnC.disabled = false;
                        btnC.classList.remove('disabled');
                        // restore Connect to green
                        btnC.classList.remove('btn-secondary');
                        btnC.classList.add('btn-success');
                    }
                    if (btnD) {
                        btnD.disabled = true;
                        btnD.classList.add('disabled');
                        btnD.classList.remove('btn-success');
                        btnD.classList.add('btn-outline-secondary');
                    }
                    if (btnSeed) {
                        btnSeed.disabled = false;
                        btnSeed.classList.remove('disabled');
                        btnSeed.classList.remove('btn-outline-secondary');
                        btnSeed.classList.add('btn-outline-primary');
                    }
                }

                // Hook up buttons
                document.getElementById('btnConnect')?.addEventListener('click', startDemo);
                document.getElementById('btnDisconnect')?.addEventListener('click', stopDemo);
                document.getElementById('btnSeed')?.addEventListener('click', () => {
                    for (let i = 0; i < 8; i++) addPoint();
                });
                // Rate slider control
                const rateSlider = document.getElementById('rateSlider');
                const rateText = document.getElementById('rateText');
                rateSlider?.addEventListener('input', (e) => {
                    const val = Number(rateSlider.value);
                    pointsPerSecond = Math.min(10, Math.max(1, val));
                    if (rateText) rateText.textContent = `${pointsPerSecond} points/sec`;
                    // If running, restart timer with new rate
                    if (timer) {
                        clearInterval(timer);
                        timer = setInterval(addPoint, Math.max(50, Math.floor(1000 / pointsPerSecond)));
                    }
                });

                // Seed with a few points
                for (let i = 0; i < 8; i++) addPoint();

                // Expose for future updates
                window.pressureChart = chart;
                window.startDemoPressure = startDemo;
                window.stopDemoPressure = stopDemo;

                // Update connection badge
                const badge = document.getElementById('connStatus');
                const updateBadge = () => {
                    if (!badge) return;
                    if (timer) {
                        badge.className = 'badge text-bg-success';
                        badge.textContent = 'Connected';
                    } else {
                        badge.className = 'badge text-bg-secondary';
                        badge.textContent = 'Idle';
                    }
                };
                document.getElementById('btnConnect')?.addEventListener('click', updateBadge);
                document.getElementById('btnDisconnect')?.addEventListener('click', updateBadge);
                // Initialize button states based on timer
                (function initButtons(){
                    const btnC = document.getElementById('btnConnect');
                    const btnD = document.getElementById('btnDisconnect');
                    const btnSeed = document.getElementById('btnSeed');
                    if (btnC) btnC.disabled = !!timer;
                    if (btnC) {
                        btnC.classList.remove('btn-success', 'btn-secondary');
                        btnC.classList.add(timer ? 'btn-secondary' : 'btn-success');
                    }
                    if (btnD) {
                        btnD.disabled = !timer;
                        // Style based on connection state
                        btnD.classList.remove('btn-success', 'btn-outline-secondary');
                        btnD.classList.add(timer ? 'btn-success' : 'btn-outline-secondary');
                    }
                    if (btnSeed) {
                        btnSeed.disabled = !!timer;
                        btnSeed.classList.remove('btn-outline-primary', 'btn-outline-secondary');
                        btnSeed.classList.add(timer ? 'btn-outline-secondary' : 'btn-outline-primary');
                    }
                })();
                updateBadge();
            })();
        </script>
    </body>
</html>